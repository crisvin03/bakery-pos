{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<style>
  /* Page header */
  .page-head { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
  .kpi {
    padding:.5rem .9rem; border:1px solid rgba(0,0,0,.06); border-radius:.75rem;
    background: linear-gradient(180deg,#fff, #fafafa); box-shadow: 0 1px 0 rgba(16,24,40,.04) inset;
    font-size:.95rem;
  }

  /* Card & toolbar */
  .card-elevated { border: 1px solid rgba(0,0,0,.06); border-radius: 1rem; box-shadow: 0 10px 24px rgba(16,24,40,.06); }
  .toolbar { display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; }
  .toolbar .search { width:min(380px, 100%); }
  .btn-primary-gradient { background: linear-gradient(135deg, #0d6efd, #20c997); border: none; }
  .btn-primary-gradient:hover { filter: brightness(.96); }

  /* Table polish */
  .table thead th { font-weight:600; color:#6b7280; border-bottom-color:rgba(0,0,0,.06); }
  .table tbody td { vertical-align: middle; }
  .table-hover>tbody>tr:hover>* { background-color: #fafbff; }
  .table-sticky thead th { position: sticky; top: 0; z-index: 5; background: #fff; }

  /* Cells */
  .thumb { width: 44px; height: 44px; border-radius: 12px; object-fit: cover;
           background:#f1f3f5; border:1px solid rgba(0,0,0,.06); }
  .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:.4rem; }
  .num { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .actions .btn { padding:.35rem .55rem; }

  @media (max-width: 576px) { .hide-sm { display:none; } }
</style>

<div class="page-head mb-3">
  <div>
    <h2 class="h4 mb-1">Products</h2>
    <div class="text-secondary small">Manage your bakery catalog.</div>
  </div>
  <div class="kpi">Total items: <strong>{{ products|length }}</strong></div>
</div>

<div class="card card-elevated">
  <div class="card-body">
    <div class="toolbar mb-3">
      <!-- SEARCH (auto-restore when cleared; NO reset button) -->
      <form method="get" id="searchForm" class="d-flex search" action="/products/">
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5L20.5 19l-5-5Zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14Z"/>
            </svg>
          </span>
          <!-- IMPORTANT: no HTML comments inside this start tag -->
          <input id="q" type="search" name="q"
                 value="{{ q|default:'' }}"
                 class="form-control border-start-0"
                 placeholder="Search products…">
        </div>
        <button class="btn btn-outline-secondary ms-2" type="submit">Search</button>
      </form>

      <a href="/products/new/" class="btn btn-primary-gradient text-white ms-auto">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="me-1">
          <path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6Z"/>
        </svg>
        New Product
      </a>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle table-sticky mb-0">
        <thead>
          <tr>
            <th style="width:64px">Image</th>
            <th>Name</th>
            <th class="text-end hide-sm" style="width:160px">Price</th>
            <th class="hide-sm" style="width:140px">Status</th>
            <th class="text-end" style="width:160px">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for p in products %}
          <tr>
            <td>
              {% if p.image %}
                <img src="{{ p.image.url }}" alt="{{ p.name }}" class="thumb">
              {% else %}
                <svg class="thumb" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <rect width="24" height="24" rx="6" fill="#eef2f7"/>
                  <path d="M6 15l3-3 2 2 3-4 4 6H6z" fill="#c8d3e0"/>
                </svg>
              {% endif %}
            </td>
            <td>
              <div class="fw-semibold">{{ p.name }}</div>
              {% if p.ingredients %}
                <div class="text-secondary small text-truncate" style="max-width:520px">{{ p.ingredients }}</div>
              {% endif %}
            </td>
            <td class="text-end hide-sm num">₱{{ p.price|floatformat:2 }}</td>
            <td class="hide-sm">
              {% if p.is_active %}
                <span class="status-dot bg-success"></span><span class="text-success">Active</span>
              {% else %}
                <span class="status-dot bg-secondary"></span><span class="text-muted">Inactive</span>
              {% endif %}
            </td>
            <td class="text-end actions">
              <div class="btn-group" role="group" aria-label="Actions">
                <a class="btn btn-outline-secondary" href="/products/{{ p.id }}/edit/" data-bs-toggle="tooltip" title="Edit">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm2.92 2.33H5v-.92l8.06-8.06.92.92-8.06 8.06ZM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83Z"/>
                  </svg>
                </a>
                <a class="btn btn-outline-danger" href="/products/{{ p.id }}/delete/" data-bs-toggle="tooltip" title="Delete">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 7h12v2H6V7Zm2 3h8l-.8 9.6A2 2 0 0 1 13.21 22h-2.42A2 2 0 0 1 8.8 19.6L8 10Zm3-7h4l1 1h3v2H4V4h3l1-1h4Z"/>
                  </svg>
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center text-secondary py-5">
              No products found. Click <b>New Product</b> to add your first item.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Enable Bootstrap tooltips
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

  // Auto-restore full list when the search field becomes empty (no extra click)
  (function () {
    const form = document.getElementById('searchForm');
    const input = document.getElementById('q');
    const base  = form.getAttribute('action') || window.location.pathname;

    function maybeReset() {
      if (input.value.trim() === '' && new URLSearchParams(location.search).has('q')) {
        window.location.replace(base);
      }
    }
    input.addEventListener('input',  maybeReset);
    input.addEventListener('search', maybeReset);
  })();
</script>
{% endblock %}
