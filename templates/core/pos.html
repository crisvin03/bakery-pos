{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<style>
  /* ===== POS layout polish ===== */
  .product-card{
    border:1px solid rgba(0,0,0,.06);
    border-radius:1rem;
    overflow:hidden;
    background:#fff;
    box-shadow:0 6px 20px rgba(16,24,40,.06);

    /* equal height cards */
    display:flex;
    flex-direction:column;
    height:100%;
  }

  /* uniform image area across all cards */
  .thumb-wrap{
    width:100%;
    aspect-ratio:4/3;              /* modern browsers */
    background:#f6f7f9;
    display:grid;
    place-items:center;
    flex-shrink:0;
    overflow:hidden;
  }
  .thumb{width:100%;height:100%;object-fit:cover}
  .placeholder svg{width:38px;height:38px;opacity:.35}

  /* Fallback for browsers without aspect-ratio */
  @supports not (aspect-ratio: 4 / 3) {
    .thumb-wrap{ position:relative; height:0; padding-top:75%; }
    .thumb-wrap > img,
    .thumb-wrap > .placeholder{ position:absolute; inset:0; width:100%; height:100%; }
  }

  .price{color:#0d6efd;font-weight:700; min-height:1.25rem;} /* 1-line reserve */

  /* content fills space; add row pinned to bottom */
  .product-card .p-2{
    display:flex;
    flex-direction:column;
    gap:.35rem;
    flex:1 1 auto;
  }

  /* 2-line clamp so names don't stretch cards */
.name-2line{
  /* standard + vendor-prefixed for widest support */
  line-clamp: 2;              /* NEW: satisfies linter */
  -webkit-line-clamp: 2;

  display: -webkit-box;
  -webkit-box-orient: vertical;

  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.2;
  min-height: 2.4em;          /* space for 2 lines */
}


  /* anchor qty+Add row at the bottom */
  .product-card form{ margin-top:auto }

  /* consistent stepper sizing */
  .qty-stepper{ width:116px }
  .qty-stepper .btn{ min-width:34px }
  .qty-stepper input{ max-width:48px; text-align:center }

  /* explicitly lock heights on stepper controls */
  .qty-stepper .btn,
  .qty-stepper .form-control{ height:32px; padding-top:0; padding-bottom:0; }

  /* uniform Add button width so everything lines up */
  .btn-add{ min-width:72px; } /* same width across cards */

  .card-elevated{border:1px solid rgba(0,0,0,.06);border-radius:1rem;box-shadow:0 10px 24px rgba(16,24,40,.06)}
  .table thead th{font-weight:600;color:#6b7280;border-bottom-color:rgba(0,0,0,.06)}
  .cart-subtotals span{font-variant-numeric:tabular-nums}
</style>

<div class="row g-4">
  <!-- ===== LEFT: product grid ===== -->
  <div class="col-lg-7">
    <div class="card card-elevated p-3">
      <div class="d-flex align-items-center mb-3">
        <h5 class="mb-0">Products</h5>
        <div class="ms-auto small text-secondary">{{ products|length }} items</div>
      </div>

      <div class="row row-cols-2 row-cols-md-3 g-3">
        {% for p in products %}
        <div class="col">
          <div class="product-card h-100">
            <div class="thumb-wrap">
              {% if p.image %}
                <img class="thumb" src="{{ p.image.url }}" alt="{{ p.name }}">
              {% else %}
                <div class="thumb placeholder d-grid place-items-center">
                  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M21 19V5a2 2 0 0 0-2-2H5C3.9 3 3 3.9 3 5v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2ZM8.5 11A2.5 2.5 0 1 0 8.5 6a2.5 2.5 0 0 0 0 5Zm-3.5 6 4.5-6 3.5 4.5 2.5-3 4.5 4.5H5Z"/>
                  </svg>
                </div>
              {% endif %}
            </div>
            <div class="p-2">
              <div class="fw-semibold name-2line" title="{{ p.name }}">{{ p.name }}</div>
              <div class="price">â‚±{{ p.price|floatformat:2 }}</div>

              <form method="post" action="/pos/add-to-cart/{{ p.id }}/" class="mt-2 d-flex align-items-stretch gap-2">
                {% csrf_token %}
                <div class="input-group input-group-sm qty-stepper">
                  <button class="btn btn-outline-secondary" type="button" data-step="-1">âˆ’</button>
                  <input type="number" name="qty" class="form-control text-center" value="1" min="1">
                  <button class="btn btn-outline-secondary" type="button" data-step="1">+</button>
                </div>
                <button class="btn btn-success btn-sm btn-add">Add</button>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ===== RIGHT: cart ===== -->
  <div class="col-lg-5">
    <div class="card card-elevated p-3">
      <h5 class="mb-3">Cart</h5>

      {% with cart=request.session.cart %}
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="small">
            <tr>
              <th>Item</th>
              <th class="text-center" style="width:160px">Qty</th>
              <th class="text-end">Subtotal</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody id="cartBody">
            {% if cart %}
              {% for pid,item in cart.items %}
              {% widthratio item.unit_price 1 item.qty as line_total %}
              <tr data-price="{{ item.unit_price }}">
                <td class="fw-semibold">{{ item.name }}</td>

                <td>
                  <form method="post" action="/pos/update-cart/{{ pid }}/" class="d-flex justify-content-center align-items-center gap-2">
                    {% csrf_token %}
                    <div class="input-group input-group-sm qty-stepper" style="max-width: 140px;">
                      <button class="btn btn-outline-secondary" type="button" data-step="-1">âˆ’</button>
                      <input type="number" name="qty" min="0" value="{{ item.qty }}" class="form-control text-center cart-qty">
                      <button class="btn btn-outline-secondary" type="button" data-step="1">+</button>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm">Update</button>
                  </form>
                </td>

                <td class="text-end cart-sub">â‚±{{ line_total|floatformat:2 }}</td>

                <td class="text-end">
                  <form method="post" action="/pos/update-cart/{{ pid }}/" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="qty" value="0">
                    <button class="btn btn-outline-danger btn-sm" title="Remove">ðŸ—‘</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="4" class="text-center text-muted py-4">Cart is empty</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      {% if cart %}
      <div class="pt-3 mt-3 border-top">
        <div class="cart-subtotals d-flex justify-content-between mb-2">
          <span class="text-secondary">Subtotal</span>
          <span id="subtotalText">â‚±0.00</span>
        </div>

        <form method="post" action="/pos/checkout/" id="checkoutForm">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label">Discount (â‚±)</label>
            <input type="number" name="discount" id="discountInput" step="0.01" value="0" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Payment Method</label>
            <select name="payment_method" class="form-select">
              <option value="CASH">Cash</option>
              <option value="CARD">Card</option>
              <option value="E_WALLET">E-Wallet</option>
            </select>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="fs-6">Total</span>
            <span class="fs-5 fw-bold" id="totalText">â‚±0.00</span>
          </div>

          <button class="btn btn-primary w-100">Checkout</button>
        </form>
      </div>
      {% endif %}
      {% endwith %}
    </div>
  </div>
</div>

<script>
  // stepper buttons for quantity fields
  document.querySelectorAll('.qty-stepper').forEach(group => {
    group.addEventListener('click', e => {
      const btn = e.target.closest('button[data-step]');
      if (!btn) return;
      const input = group.querySelector('input[type="number"]');
      const step = parseInt(btn.getAttribute('data-step'), 10);
      const min = parseInt(input.getAttribute('min') || '0', 10);
      input.value = Math.max(min, (parseInt(input.value || '0', 10) + step));
      input.dispatchEvent(new Event('input', { bubbles: true }));
    });
  });

  // client-side subtotal & total preview
  function recompute() {
    let subtotal = 0;
    document.querySelectorAll('#cartBody tr[data-price]').forEach(row => {
      const price = parseFloat(row.getAttribute('data-price'));
      const qty = parseFloat(row.querySelector('input.cart-qty')?.value || '0');
      const line = price * qty;
      subtotal += line;
      const cell = row.querySelector('.cart-sub');
      if (cell) cell.textContent = 'â‚±' + line.toFixed(2);
    });
    const subtotalText = document.getElementById('subtotalText');
    if (subtotalText) subtotalText.textContent = 'â‚±' + subtotal.toFixed(2);

    const discount = parseFloat(document.getElementById('discountInput')?.value || '0');
    const total = Math.max(0, subtotal - discount);
    const totalText = document.getElementById('totalText');
    if (totalText) totalText.textContent = 'â‚±' + total.toFixed(2);
  }
  document.getElementById('cartBody')?.addEventListener('input', e => {
    if (e.target.matches('input.cart-qty')) recompute();
  });
  document.getElementById('discountInput')?.addEventListener('input', recompute);
  recompute();
</script>

{% endblock %}
